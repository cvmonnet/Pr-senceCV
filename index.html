<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gestion Présence</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 480px;
    margin: auto;
    padding: 1em;
    background: #f4f6f8;
  }
  h1 {
    text-align: center;
    color: #333;
  }
  select, button {
    width: 100%;
    padding: 0.6em;
    margin: 0.5em 0 1em 0;
    font-size: 1em;
  }
  .eleve-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.4em;
    padding: 0.4em;
    background: white;
    border-radius: 4px;
  }
  .eleve-row:nth-child(even) {
    background: #e9ecef;
  }
  .status-select {
    width: 130px;
    padding: 0.2em 0.4em;
    font-size: 0.9em;
  }
  .status-present { background-color: #c8e6c9; }
  .status-absent { background-color: #ffcdd2; }
  .status-retard { background-color: #fff9c4; }
  .status-absentjust { background-color: #bbdefb; }
  #message {
    margin-top: 1em;
    font-weight: bold;
    text-align: center;
  }
</style>
</head>
<body>

<h1>Gestion des présences</h1>

<label for="groupeSelect">Choisir un groupe :</label>
<select id="groupeSelect">
  <option value="">-- Sélectionnez un groupe --</option>
  <option value="Présence G1">Présence G1</option>
  <option value="Présence G2">Présence G2</option>
  <option value="Présence CVnews">Présence CVnews</option>
</select>

<label for="dateSelect">Choisir une date :</label>
<select id="dateSelect" disabled>
  <option value="">-- Sélectionnez une date --</option>
</select>

<div id="elevesContainer"></div>

<button id="terminerBtn" disabled>Terminer l'appel</button>

<div id="message"></div>

<script>
const scriptUrl = "https://script.google.com/macros/s/AKfycbzimXMnSzIMCN9Ei39GwWmK8R18zX0F1iGMFjf5EflGSNnGY4yrGxGRYinr5qNud5Qtqw/exec";

const groupeSelect = document.getElementById("groupeSelect");
const dateSelect = document.getElementById("dateSelect");
const elevesContainer = document.getElementById("elevesContainer");
const terminerBtn = document.getElementById("terminerBtn");
const messageDiv = document.getElementById("message");

let currentEleves = [];
let currentPresences = [];
let currentGroupe = "";
let currentDate = "";

// Statuts possibles
const statuts = [
  { value: "", label: "—" },
  { value: "présent", label: "Présent", className: "status-present" },
  { value: "absent", label: "Absent", className: "status-absent" },
  { value: "retard", label: "Retard", className: "status-retard" },
  { value: "absent justifié", label: "Absent Justifié", className: "status-absentjust" }
];

// Lors du choix du groupe, on récupère les dates
groupeSelect.addEventListener("change", async () => {
  clearMessage();
  currentGroupe = groupeSelect.value;
  currentDate = "";
  dateSelect.innerHTML = '<option value="">-- Sélectionnez une date --</option>';
  elevesContainer.innerHTML = "";
  terminerBtn.disabled = true;
  dateSelect.disabled = true;
  if (!currentGroupe) return;

  try {
    const res = await fetch(`${scriptUrl}?mode=dates&groupe=${encodeURIComponent(currentGroupe)}`);
    const data = await res.json();
    if (data.dates.length === 0) {
      // Pas de dates, on propose la date d'aujourd'hui par défaut
      const today = new Date();
      const todayStr = formatDate(today);
      dateSelect.innerHTML += `<option value="${todayStr}">${todayStr} (nouvelle date)</option>`;
    } else {
      data.dates.forEach(d => {
        dateSelect.innerHTML += `<option value="${d}">${d}</option>`;
      });
      // Ajouter aussi la date d'aujourd'hui si pas déjà présente
      const today = formatDate(new Date());
      if (!data.dates.includes(today)) {
        dateSelect.innerHTML += `<option value="${today}">${today} (nouvelle date)</option>`;
      }
    }
    dateSelect.disabled = false;
  } catch (e) {
    showMessage("Erreur lors du chargement des dates");
  }
});

// Lors du choix de la date, on récupère la liste des élèves + présences
dateSelect.addEventListener("change", async () => {
  clearMessage();
  currentDate = dateSelect.value;
  elevesContainer.innerHTML = "";
  terminerBtn.disabled = true;
  if (!currentDate || !currentGroupe) return;

  try {
    const res = await fetch(`${scriptUrl}?mode=eleves&groupe=${encodeURIComponent(currentGroupe)}&date=${encodeURIComponent(currentDate)}`);
    const data = await res.json();
    currentEleves = data.eleves || [];
    currentPresences = data.presences || [];

    elevesContainer.innerHTML = "";

    currentEleves.forEach((eleve, i) => {
      const pres = currentPresences[i] || "";
      const div = document.createElement("div");
      div.className = "eleve-row";
      div.innerHTML = `
        <div>${eleve}</div>
        <select class="status-select" data-index="${i}">
          ${statuts.map(s => `<option value="${s.value}" ${s.value === pres ? "selected" : ""}>${s.label}</option>`).join("")}
        </select>
      `;
      elevesContainer.appendChild(div);
    });

    // Coloration initiale
    updateColors();

    terminerBtn.disabled = false;
  } catch (e) {
    showMessage("Erreur lors du chargement des élèves");
  }
});

// Met à jour les couleurs selon les statuts
function updateColors() {
  document.querySelectorAll(".status-select").forEach(select => {
    const val = select.value;
    select.className = "status-select"; // reset
    const status = statuts.find(s => s.value === val);
    if (status && status.className) {
      select.classList.add(status.className);
    }
  });
}

// Quand on change un statut, on colore la case
elevesContainer.addEventListener("change", (e) => {
  if (e.target.classList.contains("status-select")) {
    updateColors();
  }
});

// Bouton terminer
terminerBtn.addEventListener("click", async () => {
  clearMessage();
  terminerBtn.disabled = true;

  // Récupérer le tableau des présences sélectionnées
  const presences = Array.from(document.querySelectorAll(".status-select")).map(s => s.value);

  try {
    const res = await fetch(scriptUrl, {
      method: "POST",
      body: JSON.stringify({
        groupe: currentGroupe,
        date: currentDate,
        presence: presences
      }),
      headers: {
        "Content-Type": "application/json"
      }
    });
    const text = await res.text();
    showMessage(text);
  } catch (e) {
    showMessage("Erreur lors de l'enregistrement");
  } finally {
    terminerBtn.disabled = false;
  }
});

function formatDate(date) {
  // format jj/mm/aa
  const d = ("0" + date.getDate()).slice(-2);
  const m = ("0" + (date.getMonth() + 1)).slice(-2);
  const y = date.getFullYear().toString().slice(-2);
  return `${d}/${m}/${y}`;
}

function showMessage(msg) {
  messageDiv.textContent = msg;
}

function clearMessage() {
  messageDiv.textContent = "";
}
</script>

</body>
</html>
